<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>EngageSphere / Upcoming Events</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✧</text></svg>">
    <link rel="stylesheet" href="/styles.css">
</head>
<body>



<div class="container">
    <header class="app-header">
        <a href="/" class="logo">
            <span class="logo-symbol">✧</span>
            <span class="logo-text">EngageSphere</span>
        </a>
        <nav class="main-nav" id="main-nav">
            <!-- Links will be dynamically added here -->
            <!-- <a href="/signup.html" class="nav-link">Sign Up</a> -->
            <!-- <a href="/login.html" class="nav-link">Login</a> -->
        </nav>
    </header>

    <div class="page-header">
        <h1>Upcoming Events</h1>
        <a href="/create-event.html" class="btn btn-primary" id="create-event-btn" style="display: none;">Create New Event</a>
    </div>

    <ul id="event-list" class="event-list">
        <!-- Events will be loaded here by JavaScript -->
    </ul>
</div>

<div class="chatbot-container">
    <div class="chat-window" id="chat-window">
        <div class="chat-header">EngageSphere Assistant</div>
        <div class="chat-body" id="chat-body">
            <div class="chat-message bot-message">Hello! How can I help you with EngageSphere today?</div>
        </div>
        <form class="chat-input" id="chat-form">
            <input type="text" id="chat-input-field" placeholder="Ask a question..." autocomplete="off">
            <button type="submit">➤</button>
        </form>
    </div>
    <button class="chat-toggle" id="chat-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16">
            <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.5a1 1 0 0 0-.8.4l-1.9 2.533a1 1 0 0 1-1.6 0L5.3 12.4a1 1 0 0 0-.8-.4H2a2 2 0 0 1-2-2V2zm3.5 1a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h9a.5.5 0 0 0 0-1h-9zm0 2.5a.5.5 0 0 0 0 1h5a.5.5 0 0 0 0-1h-5z"/>
        </svg>
    </button>
</div>



<script>
    const API_BASE_URL = "http://127.0.0.1:8001";
    const eventList = document.getElementById('event-list');
    const mainNav = document.getElementById('main-nav');
    const createEventBtn = document.getElementById('create-event-btn');

    /**
     * A wrapper for the fetch API that automatically handles JWT authentication
     * and redirects to the login page on 401 Unauthorized errors.
     */
    async function fetchWithAuth(url, options = {}) {
        const token = localStorage.getItem('accessToken');

        if (!token) {
            window.location.href = '/login.html';
            // Return a promise that never resolves to prevent further execution
            return new Promise(() => {});
        }

        const headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`
        };

        const response = await fetch(url, { ...options, headers });

        if (response.status === 401) {
            localStorage.removeItem('accessToken');
            window.location.href = '/login.html';
            return new Promise(() => {});
        }

        return response;
    }


    async function updateNavAndButtons() {
        const mainNav = document.getElementById('main-nav');
        mainNav.innerHTML = ''; // Clear existing links
        const token = localStorage.getItem('accessToken');

        if (token) {
            let user = null;
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/users/me`);
                if (response.ok) {
                    user = await response.json();
                } else if (response.status !== 401) { 
                    console.error("Failed to fetch user details:", response.statusText);
                }
            } catch (e) { 
                console.error("Could not fetch user details:", e); 
            }

            if (user && user.profile_image_url) {
                const profilePic = document.createElement('img');
                profilePic.src = user.profile_image_url;
                profilePic.alt = 'Profile';
                profilePic.className = 'nav-profile-pic';
                mainNav.appendChild(profilePic);
            }

            const settingsLink = document.createElement('a');
            settingsLink.href = '/settings.html';
            settingsLink.className = 'btn btn-secondary';
            settingsLink.textContent = 'Settings';
            mainNav.appendChild(settingsLink);

            const logoutButton = document.createElement('a');
            logoutButton.href = '#';
            logoutButton.className = 'btn btn-danger';
            logoutButton.textContent = 'Logout';
            logoutButton.onclick = () => {
                localStorage.removeItem('accessToken');
                window.location.href = '/login.html'; // Go to login after logout
            };
            mainNav.appendChild(logoutButton);

            if (user && user.is_admin) createEventBtn.style.display = 'inline-block';

        } else {
            // If there's no token, show login/signup buttons
            const signupLink = document.createElement('a');
            signupLink.href = '/signup.html';
            signupLink.className = 'btn btn-secondary';
            signupLink.textContent = 'Sign Up';

            const loginLink = document.createElement('a');
            loginLink.href = '/login.html';
            loginLink.className = 'btn btn-primary';
            loginLink.textContent = 'Login';

            mainNav.appendChild(signupLink);
            mainNav.appendChild(loginLink);
            createEventBtn.style.display = 'none';
        }
    }

    async function deleteEvent(eventId) {
        if (!confirm('Are you sure you want to delete this event? This will also cancel all scheduled communications for it.')) {
            return;
        }

        try {
            const response = await fetchWithAuth(`${API_BASE_URL}/events/${eventId}`, {
                method: 'DELETE',
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to delete event.');
            }
            
            alert('Event deleted successfully!');
            loadEvents(); // Refresh the event list

        } catch (error) {
            console.error('Error deleting event:', error);
            alert(`Error: ${error.message}`);
        }
    }

    async function loadEvents() {
        const eventList = document.getElementById('event-list');
        eventList.innerHTML = ''; // Clear list
        for (let i = 0; i < 3; i++) { /* ... skeleton loader code ... */ }

        try {
            let registeredEventIds = [];
            let userIsAdmin = false;
            const token = localStorage.getItem('accessToken');

            // Fetch user-specific data only if logged in
            if (token) {
                const [regResponse, userResponse] = await Promise.all([
                    fetchWithAuth(`${API_BASE_URL}/users/me/registrations`),
                    fetchWithAuth(`${API_BASE_URL}/users/me`)
                ]);

                if (regResponse.ok) registeredEventIds = await regResponse.json();
                if (userResponse.ok) {
                    const user = await userResponse.json();
                    userIsAdmin = user.is_admin;
                }
            }

            // Events are public, so we fetch them without auth
            const response = await fetch(`${API_BASE_URL}/events/`);
            if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
            const events = await response.json();
            
            eventList.innerHTML = ''; // Clear skeletons
            if (events.length === 0) {
                eventList.innerHTML = '<li><p>No events found. Why not create one?</p></li>';
                return;
            }

            events.forEach(event => {
                const listItem = document.createElement('li');
                listItem.className = 'event-item';
                const eventDate = new Date(event.event_time).toLocaleString([], { dateStyle: 'medium', timeStyle: 'short' });
                const isRegistered = registeredEventIds.includes(event.id);

                let imageHtml = '';
                if (event.image_url) {
                    imageHtml = `<img src="${event.image_url}" alt="${event.name}" class="event-image">`;
                }

                let actionButtonHtml = '';
                if (isRegistered) {
                    actionButtonHtml = `<button class="btn btn-secondary" disabled>Registered</button>`;
                } else if (token) {
                    actionButtonHtml = `<a href="/event-register.html?event_id=${event.id}" class="btn btn-success">Register Now</a>`;
                } else {
                    actionButtonHtml = `<a href="/login.html" class="btn btn-success">Login to Register</a>`;
                }

                if (userIsAdmin) {
                    actionButtonHtml += `<a href="/admin-registrations.html?event_id=${event.id}" class="btn btn-secondary" style="margin-left: 10px;">View Registrations</a>`;
                    actionButtonHtml += `<button onclick="deleteEvent(${event.id})" class="btn btn-danger" style="margin-left: 10px;">Delete</button>`;
                }

                listItem.innerHTML = `
                    ${imageHtml}
                    <div class="event-details">
                        <h3>${event.name}</h3>
                        <p>
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/></svg>
                            ${eventDate}
                        </p>
                        <p class="event-description">${event.description}</p>
                    </div>
                    <div class="event-actions">${actionButtonHtml}</div>`;
                eventList.appendChild(listItem);
            });
        } catch (error) {
            // Avoid showing error if it's a redirect from fetchWithAuth
            if (error.name !== 'AbortError') {
                 console.error("Could not load events:", error);
                 eventList.innerHTML = '<p class="error">Could not load events. Please try again later.</p>';
            }
        }
    }

    async function checkChatbotStatus() {
        const chatToggle = document.getElementById('chat-toggle');
        try {
            const response = await fetch(`${API_BASE_URL}/health/`);
            if (!response.ok) throw new Error('Health check failed.');
            
            const data = await response.json();
            if (data.llm_status !== 'ok') {
                chatToggle.disabled = true;
                chatToggle.style.backgroundColor = '#888'; // Grey out the button
                chatToggle.style.cursor = 'not-allowed';
                // Optional: add a title to explain why it's disabled
                chatToggle.title = 'Chatbot is currently unavailable.';
            }
        } catch (error) {
            console.error('Chatbot health check failed:', error);
            chatToggle.disabled = true;
            chatToggle.style.backgroundColor = '#888';
            chatToggle.style.cursor = 'not-allowed';
            chatToggle.title = 'Chatbot is currently unavailable.';
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Run all async functions concurrently
        Promise.all([updateNavAndButtons(), loadEvents(), checkChatbotStatus()]);

        // Add scroll listener for header shadow
        window.addEventListener('scroll', () => {
            if (window.scrollY > 20) {
                document.body.classList.add('scrolled');
            } else {
                document.body.classList.remove('scrolled');
            }
        });
    });

    // --- Chatbot Logic ---
    const chatWindow = document.getElementById('chat-window');
    const chatToggle = document.getElementById('chat-toggle');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input-field');
    const chatBody = document.getElementById('chat-body');

    chatToggle.addEventListener('click', () => {
        if (chatToggle.disabled) return;
        chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
    });

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = chatInput.value.trim();
        if (!query) return;

        addMessage(query, 'user-message');
        chatInput.value = '';

        try {
            const response = await fetch(`${API_BASE_URL}/chatbot/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            if (!response.ok) throw new Error('Failed to get response from bot.');
            const data = await response.json();
            addMessage(data.response, 'bot-message');
        } catch (error) {
            console.error('Chatbot error:', error);
            addMessage('Sorry, I encountered an error. Please try again.', 'bot-message');
        }
    });

    function addMessage(text, className) {
        const messageElement = document.createElement('div');
        messageElement.className = `chat-message ${className}`;
        messageElement.textContent = text;
        chatBody.appendChild(messageElement);
        chatBody.scrollTop = chatBody.scrollHeight; // Scroll to bottom
    }
</script>

</body>
</html>
